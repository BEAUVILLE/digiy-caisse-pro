<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGIY Dashboard Central ‚Äî Batch Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: #0f172a; color: #f8fafc; min-height: 100vh; }
        
        .header { padding: 20px 30px; background: linear-gradient(135deg, #1e293b, #0f172a); border-bottom: 2px solid #fbbf24; }
        .header h1 { color: #fbbf24; font-size: 24px; display: flex; align-items: center; gap: 15px; }
        .header h1::before { content: "ü¶Ö"; font-size: 30px; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 30px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #1e293b; padding: 25px; border-radius: 15px; border: 1px solid rgba(251, 191, 36, 0.2); }
        .stat-card h3 { color: #94a3b8; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .stat-card .value { color: #fbbf24; font-size: 32px; font-weight: 800; }
        .stat-card .label { color: #64748b; font-size: 11px; margin-top: 5px; }
        
        .chart-container { background: #1e293b; padding: 25px; border-radius: 15px; margin-bottom: 30px; border: 1px solid rgba(251, 191, 36, 0.1); }
        .chart-container h2 { color: #fbbf24; font-size: 18px; margin-bottom: 20px; }
        
        .stores-table { background: #1e293b; padding: 25px; border-radius: 15px; border: 1px solid rgba(251, 191, 36, 0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #0f172a; color: #fbbf24; padding: 15px; text-align: left; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #f8fafc; }
        tr:hover { background: rgba(251, 191, 36, 0.05); }
        
        .loading { text-align: center; padding: 60px; color: #94a3b8; }
        .loading::before { content: "‚è≥"; font-size: 40px; display: block; margin-bottom: 15px; }
        
        .refresh-btn { position: fixed; bottom: 30px; right: 30px; padding: 15px 25px; background: linear-gradient(135deg, #fbbf24, #d97706); border: none; border-radius: 12px; color: #000; font-weight: 800; cursor: pointer; font-size: 12px; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4); }
        .refresh-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(251, 191, 36, 0.6); }
        
        .eco-badge { position: fixed; top: 20px; right: 30px; background: #10b981; color: white; padding: 8px 15px; border-radius: 8px; font-size: 11px; font-weight: 700; }
    </style>
</head>
<body>

<div class="eco-badge">üåø Data ultra-l√©g√®re : ~6 KB/mois</div>

<div class="header">
    <h1>DASHBOARD CENTRAL ‚Äî Batch Edition</h1>
    <p style="color: #94a3b8; font-size: 13px; margin-top: 10px;">Synchronisation quotidienne ‚Ä¢ 99.9% √©conomie data ‚Ä¢ Pierre par pierre ‚àû</p>
</div>

<div class="container">
    <div id="loading" class="loading">Chargement des donn√©es...</div>
    
    <div id="content" style="display: none;">
        <!-- Stats principales -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>CA Aujourd'hui</h3>
                <div class="value" id="caToday">0 F</div>
                <div class="label" id="ventesToday">0 ventes</div>
            </div>
            
            <div class="stat-card">
                <h3>CA Ce Mois</h3>
                <div class="value" id="caMonth">0 F</div>
                <div class="label" id="ventesMonth">0 ventes</div>
            </div>
            
            <div class="stat-card">
                <h3>Boutiques Actives</h3>
                <div class="value" id="storesActive">0</div>
                <div class="label">Derniers 30 jours</div>
            </div>
            
            <div class="stat-card">
                <h3>Data Consomm√©e</h3>
                <div class="value" id="dataUsed">0 KB</div>
                <div class="label">Dernier mois</div>
            </div>
        </div>

        <!-- Graphique √©volution -->
        <div class="chart-container">
            <h2>üìà √âvolution des 7 derniers jours</h2>
            <canvas id="evolutionChart" height="80"></canvas>
        </div>

        <!-- R√©partition paiements -->
        <div class="chart-container">
            <h2>üí≥ R√©partition des paiements (aujourd'hui)</h2>
            <canvas id="paymentChart" height="80"></canvas>
        </div>

        <!-- Table boutiques -->
        <div class="stores-table">
            <h2 style="color: #fbbf24; margin-bottom: 20px;">üè™ Performance par boutique (30 derniers jours)</h2>
            <table id="storesTable">
                <thead>
                    <tr>
                        <th>Boutique</th>
                        <th>CA Total</th>
                        <th>Ventes</th>
                        <th>CA Moyen/Jour</th>
                        <th>Jours Actifs</th>
                        <th>Derni√®re Sync</th>
                    </tr>
                </thead>
                <tbody id="storesBody"></tbody>
            </table>
        </div>
    </div>
</div>

<button class="refresh-btn" onclick="loadData()">üîÑ Actualiser</button>

<script>
    
// =============================
// CONFIG SUPABASE
// =============================
const SUPABASE_URL = 'https://wesqmwjjtsefyjnluosj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let evolutionChartInstance = null;
let paymentChartInstance = null;

// =============================
// LOAD DATA
// =============================
async function loadData() {
    try {
        // Charger toutes les ventes
        const { data: allSales, error: salesError } = await supabase
            .from('digiy_caisse_sales')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (salesError) throw salesError;

        // Charger settings boutiques
        const { data: allSettings, error: settingsError } = await supabase
            .from('digiy_caisse_settings')
            .select('*');
        
        if (settingsError) throw settingsError;

        // Calculer stats
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

        // Ventes aujourd'hui
        const todaySales = allSales.filter(s => {
            const saleDate = new Date(s.created_at);
            return saleDate >= today;
        });

        const caToday = todaySales.reduce((sum, s) => sum + (s.total || 0), 0);
        const ventesToday = todaySales.length;

        document.getElementById('caToday').textContent = caToday.toLocaleString() + ' F';
        document.getElementById('ventesToday').textContent = ventesToday + ' ventes';

        // Ventes ce mois
        const monthSales = allSales.filter(s => {
            const saleDate = new Date(s.created_at);
            return saleDate >= monthStart;
        });

        const caMonth = monthSales.reduce((sum, s) => sum + (s.total || 0), 0);
        const ventesMonth = monthSales.length;

        document.getElementById('caMonth').textContent = caMonth.toLocaleString() + ' F';
        document.getElementById('ventesMonth').textContent = ventesMonth + ' ventes';

        // Boutiques actives (30 derniers jours)
        const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        const activeSales = allSales.filter(s => new Date(s.created_at) >= thirtyDaysAgo);
        const activeOwners = new Set(activeSales.map(s => s.owner_id));

        document.getElementById('storesActive').textContent = activeOwners.size;

        // Data consomm√©e (estimation)
        const dataUsed = JSON.stringify(monthSales).length;
        document.getElementById('dataUsed').textContent = (dataUsed / 1024).toFixed(2) + ' KB';

        // Charger graphiques
        await loadEvolutionChart(allSales);
        await loadPaymentChart(todaySales);
        await loadStoresTable(allSales, allSettings);

        // Afficher contenu
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

    } catch (error) {
        console.error('Erreur chargement:', error);
        document.getElementById('loading').innerHTML = '‚ùå Erreur de chargement<br><small>' + (error.message || error) + '</small>';
    }
}

// =============================
// √âVOLUTION 7 JOURS
// =============================
async function loadEvolutionChart(sales) {
    const now = new Date();
    const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

    // Filtrer derniers 7 jours
    const recentSales = sales.filter(s => new Date(s.created_at) >= sevenDaysAgo);

    // Agr√©ger par jour
    const byDate = {};
    recentSales.forEach(s => {
        const date = new Date(s.created_at).toISOString().split('T')[0];
        if (!byDate[date]) byDate[date] = { ca: 0, ventes: 0 };
        byDate[date].ca += s.total || 0;
        byDate[date].ventes += 1;
    });

    // Remplir tous les jours (m√™me 0)
    for (let i = 6; i >= 0; i--) {
        const d = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
        const dateKey = d.toISOString().split('T')[0];
        if (!byDate[dateKey]) byDate[dateKey] = { ca: 0, ventes: 0 };
    }

    const sortedDates = Object.keys(byDate).sort();
    const labels = sortedDates.map(d => new Date(d).toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' }));
    const caData = sortedDates.map(d => byDate[d].ca);
    const ventesData = sortedDates.map(d => byDate[d].ventes);

    const ctx = document.getElementById('evolutionChart').getContext('2d');
    if (evolutionChartInstance) evolutionChartInstance.destroy();
    
    evolutionChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'CA (F)',
                data: caData,
                borderColor: '#fbbf24',
                backgroundColor: 'rgba(251, 191, 36, 0.1)',
                tension: 0.4,
                yAxisID: 'y'
            }, {
                label: 'Ventes',
                data: ventesData,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: '#f8fafc' } } },
            scales: {
                y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y1: { position: 'right', beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { display: false } },
                x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
        }
    });
}

// =============================
// R√âPARTITION PAIEMENTS
// =============================
async function loadPaymentChart(todaySales) {
    const methods = {
        'CASH': 0,
        'WAVE': 0,
        'OM': 0,
        'CB': 0,
        'CREDIT': 0
    };

    todaySales.forEach(s => {
        const method = (s.payment_method || 'CASH').toUpperCase();
        if (methods[method] !== undefined) {
            methods[method] += s.total || 0;
        } else {
            methods['CASH'] += s.total || 0; // Default
        }
    });

    const ctx = document.getElementById('paymentChart').getContext('2d');
    if (paymentChartInstance) paymentChartInstance.destroy();
    
    paymentChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Cash', 'Wave', 'Orange Money', 'Carte', 'Cr√©dit'],
            datasets: [{
                data: [methods.CASH, methods.WAVE, methods.OM, methods.CB, methods.CREDIT],
                backgroundColor: ['#10b981', '#0ea5e9', '#f97316', '#8b5cf6', '#ef4444']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { labels: { color: '#f8fafc' } },
                tooltip: {
                    callbacks: {
                        label: (context) => `${context.label}: ${context.parsed.toLocaleString()} F`
                    }
                }
            }
        }
    });
}

// =============================
// TABLE BOUTIQUES
// =============================
async function loadStoresTable(sales, settings) {
    const now = new Date();
    const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

    // Filtrer 30 derniers jours
    const recentSales = sales.filter(s => new Date(s.created_at) >= thirtyDaysAgo);

    // Agr√©ger par owner_id
    const byOwner = {};
    recentSales.forEach(s => {
        if (!byOwner[s.owner_id]) {
            byOwner[s.owner_id] = {
                ca: 0,
                ventes: 0,
                days: new Set()
            };
        }
        byOwner[s.owner_id].ca += s.total || 0;
        byOwner[s.owner_id].ventes += 1;
        
        const day = new Date(s.created_at).toISOString().split('T')[0];
        byOwner[s.owner_id].days.add(day);
    });

    const tbody = document.getElementById('storesBody');
    tbody.innerHTML = '';

    // Map settings
    const settingsMap = {};
    settings.forEach(s => {
        settingsMap[s.owner_id] = s;
    });

    // Afficher
    Object.keys(byOwner).forEach(owner_id => {
        const stats = byOwner[owner_id];
        const setting = settingsMap[owner_id] || {};
        const storeName = setting.store_name || 'Boutique inconnue';
        const joursActifs = stats.days.size;
        const caMoyen = joursActifs > 0 ? Math.round(stats.ca / joursActifs) : 0;
        const lastSync = setting.updated_at || setting.created_at || new Date().toISOString();

        const row = tbody.insertRow();
        row.innerHTML = `
            <td><b>${storeName}</b></td>
            <td><b style="color: #fbbf24;">${stats.ca.toLocaleString()} F</b></td>
            <td>${stats.ventes.toLocaleString()}</td>
            <td>${caMoyen.toLocaleString()} F</td>
            <td>${joursActifs}</td>
            <td>${new Date(lastSync).toLocaleDateString('fr-FR')}</td>
        `;
    });

    // Si aucune boutique
    if (Object.keys(byOwner).length === 0) {
        const row = tbody.insertRow();
        row.innerHTML = '<td colspan="6" style="text-align:center; color:#94a3b8;">Aucune vente dans les 30 derniers jours</td>';
    }
}

// =============================
// INIT
// =============================
loadData();

// Auto-refresh toutes les 5 minutes
setInterval(loadData, 5 * 60 * 1000);

console.log('ü¶Ö DIGIY Dashboard Central - Unified Rail Edition ‚àû');
</script>

</body>
</html>

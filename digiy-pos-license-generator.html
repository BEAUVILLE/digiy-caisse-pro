<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>DIGIY POS â€” GÃ©nÃ©rateur de Licences ðŸ‘‘</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  margin:0;
  background:#020617;
  font-family:system-ui;
  color:#f9fafb;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100vh;
}
.box{
  width:520px;
  background:#030712;
  border:1px solid rgba(250,204,21,.25);
  border-radius:18px;
  padding:32px;
  box-shadow:0 20px 60px rgba(0,0,0,.6);
}
h1{
  margin:0 0 18px 0;
  font-size:24px;
  background:linear-gradient(135deg,#facc15,#f97316);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
label{font-size:13px;color:#cbd5f5}
input,select{
  width:100%;
  margin-top:6px;
  margin-bottom:16px;
  padding:12px;
  border-radius:10px;
  border:1px solid rgba(148,163,184,.25);
  background:#020617;
  color:#f9fafb;
}
button{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:none;
  background:linear-gradient(135deg,#facc15,#f97316);
  font-weight:700;
  cursor:pointer;
}
textarea{
  width:100%;
  margin-top:16px;
  padding:12px;
  background:#020617;
  border:1px solid rgba(148,163,184,.25);
  border-radius:10px;
  color:#22c55e;
  height:120px;
}
</style>
</head>

<body>
<div class="box">
<h1>DIGIY POS ðŸ‘‘ GÃ©nÃ©rateur Officiel</h1>

<label>DurÃ©e licence</label>
<select id="duration">
  <option value="30">1 mois</option>
  <option value="180">6 mois</option>
  <option value="365" selected>1 an</option>
  <option value="730">2 ans</option>
</select>

<label>Device ID (optionnel)</label>
<input id="device" placeholder="laisser vide = licence universelle">

<button onclick="generate()">GÃ©nÃ©rer Licence</button>

<textarea id="out" placeholder="La licence DIGIY apparaÃ®tra ici..."></textarea>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<script>
/* ======================================================
   DIGIY POS PRO â™¾ï¸ â€” OFFLINE TERRAIN FINAL
   DÃ©mo 15 jours via QR
   Licence PRO 31 jours renouvelable
   Stockage local IndexedDB
====================================================== */

const DB_NAME="digiy_pos_db";
const STORE="kv";
const STATE_KEY="state";

/* ===== IndexedDB ===== */
function db(){
 return new Promise((res,rej)=>{
  const r=indexedDB.open(DB_NAME,1);
  r.onupgradeneeded=e=>e.target.result.createObjectStore(STORE);
  r.onsuccess=()=>res(r.result);
 });
}
async function saveState(){
 const d=await db();
 return new Promise(r=>{
  const t=d.transaction(STORE,"readwrite");
  t.objectStore(STORE).put(appState,STATE_KEY);
  t.oncomplete=()=>r();
 });
}
async function loadState(){
 const d=await db();
 return new Promise(r=>{
  const t=d.transaction(STORE,"readonly");
  const q=t.objectStore(STORE).get(STATE_KEY);
  q.onsuccess=()=>r(q.result);
 });
}

/* ===== STATE ===== */
let appState={
 demoStart:null,
 demoDuration:15,
 licenseMeta:null,
 shopInfo:{name:"Ma Boutique"}
};

/* ===== DEMO ===== */
function validDemo(){
 if(!appState.demoStart) return false;
 const start=new Date(appState.demoStart);
 return (Date.now()-start)<appState.demoDuration*86400000;
}
function demoDaysLeft(){
 if(!appState.demoStart) return 0;
 const diff=(Date.now()-new Date(appState.demoStart))/86400000;
 return Math.max(0,Math.ceil(appState.demoDuration-diff));
}
function triggerDemoFromCode(code){
 if(code==="DIGIY-DEMO-15" && !appState.demoStart){
  appState.demoStart=new Date().toISOString();
  saveState();
  location.reload();
 }
}

/* ===== LICENCE ===== */
function validLicense(){
 return appState.licenseMeta &&
        Date.now()<new Date(appState.licenseMeta.exp).getTime();
}
function daysLeft(){
 if(!appState.licenseMeta) return 0;
 return Math.ceil((new Date(appState.licenseMeta.exp)-Date.now())/86400000);
}

/* ===== ACTIVATION PRO (SIMPLIFIÃ‰E) ===== */
async function activatePro(){
 const exp=Date.now()+31*86400000;
 appState.licenseMeta={exp};
 await saveState();
 location.reload();
}

/* ===== BLOCK ===== */
function blockIfExpired(){
 if(validLicense()) return;
 if(validDemo()) return;

 document.body.innerHTML=`
 <div style="background:#020617;color:white;height:100vh;display:flex;align-items:center;justify-content:center">
  <div style="background:#030712;padding:40px;border-radius:18px;border:1px solid gold;text-align:center">
   <h2 style="color:gold">DIGIY POS verrouillÃ©</h2>
   <p>La DÃ©mo est terminÃ©e.<br>Active ta licence PRO pour continuer.</p>
   <a href="https://wa.me/221771342889" style="background:gold;color:black;padding:12px 20px;border-radius:12px;text-decoration:none;font-weight:700">Activer</a>
  </div>
 </div>`;
}

/* ===== BADGE HEADER ===== */
function updateBadge(){
 const badge=document.getElementById("licenseBadge");
 if(validLicense()){
  badge.innerHTML="ðŸ¦… PRO â€¢ "+daysLeft()+"j";
 }
 else if(validDemo()){
  badge.innerHTML="ðŸ•’ DÃ‰MO â€¢ "+demoDaysLeft()+"j";
 }
}

/* ===== INIT ===== */
async function init(){
 const saved=await loadState();
 if(saved) appState=saved;

 blockIfExpired();
 updateBadge();
 setInterval(blockIfExpired,60000);
}

document.addEventListener("DOMContentLoaded",init);
</script>
</body>
</html>

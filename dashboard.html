<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGIY - Dashboard Local & Export</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --gold: #fbbf24; --bg: #0f172a; --card: #1e293b;
            --text: #f8fafc; --muted: #94a3b8;
            --gradient: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            --green: #10b981;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 20px; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .btn-group { display: flex; gap: 10px; }
        
        .action-btn { padding: 12px 20px; border-radius: 12px; text-decoration: none; font-size: 13px; font-weight: 700; cursor: pointer; border: none; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .back-btn { background: var(--card); color: white; border: 1px solid var(--gold); }
        .export-btn { background: var(--green); color: white; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2); }
        .action-btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); text-align: center; }
        .stat-card h2 { color: var(--gold); font-size: 2.2rem; margin-top: 10px; }
        .stat-card small { letter-spacing: 1px; color: var(--muted); }
        
        .table-container { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .data-table th { background: rgba(255,255,255,0.03); padding: 15px; text-align: left; color: var(--gold); font-size: 11px; text-transform: uppercase; }
        .data-table td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }
        
        .badge { padding: 5px 10px; border-radius: 8px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .bg-cash { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .bg-wave { background: rgba(14, 165, 233, 0.1); color: #0ea5e9; }
        .bg-om { background: rgba(249, 115, 22, 0.1); color: #f97316; }
        .bg-credit { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
    </style>
</head>
<body>

<div class="top-bar">
    <div>
        <h1 id="storeTitle" style="font-size: 24px;">MON DASHBOARD</h1>
        <p style="color: var(--muted); font-size: 12px;"><i class="fas fa-shield-alt"></i> Stockage Local Sécurisé (IndexedDB Ready)</p>
    </div>
    <div class="btn-group">
        <button class="action-btn export-btn" onclick="exportToCSV()">
            <i class="fas fa-file-excel"></i> EXPORTER (CSV)
        </button>
        <a href="index.html" class="action-btn back-btn">
            <i class="fas fa-arrow-left"></i> RETOUR
        </a>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <small>RECETTE TOTALE</small>
        <h2 id="grandTotal">0 F</h2>
    </div>
    <div class="stat-card">
        <small>VENTES RÉALISÉES</small>
        <h2 id="salesCount">0</h2>
    </div>
    <div class="stat-card">
        <small>PANIER MOYEN</small>
        <h2 id="avgCart">0 F</h2>
    </div>
</div>

<div class="table-container">
    <h3 style="padding-left: 10px;"><i class="fas fa-history" style="color: var(--gold);"></i> Journal des ventes</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>Date & Heure</th>
                <th>Montant</th>
                <th>Méthode</th>
                <th>Statut</th>
            </tr>
        </thead>
        <tbody id="salesTableBody"></tbody>
    </table>
</div>

<script>
    function loadData() {
        const storeName = localStorage.getItem('el_name') || "Ma Boutique";
        const sales = JSON.parse(localStorage.getItem('el_sales')) || [];
        
        document.getElementById('storeTitle').innerText = storeName.toUpperCase();
        
        // Calculs financiers
        const totalRev = sales.reduce((sum, s) => sum + s.total, 0);
        const count = sales.length;
        const avg = count > 0 ? Math.round(totalRev / count) : 0;
        
        document.getElementById('grandTotal').innerText = totalRev.toLocaleString() + " F";
        document.getElementById('salesCount').innerText = count;
        document.getElementById('avgCart').innerText = avg.toLocaleString() + " F";
        
        // Affichage des 15 dernières ventes
        const tableBody = document.getElementById('salesTableBody');
        tableBody.innerHTML = [...sales].reverse().slice(0, 15).map(s => `
            <tr>
                <td>${new Date(s.id).toLocaleString('fr-FR')}</td>
                <td style="font-weight:bold; color:var(--text);">${s.total.toLocaleString()} F</td>
                <td><span class="badge bg-${s.method.toLowerCase()}">${s.method}</span></td>
                <td><i class="fas fa-check-circle" style="color:var(--green)"></i> Validé</td>
            </tr>
        `).join('');
    }

    function exportToCSV() {
        const sales = JSON.parse(localStorage.getItem('el_sales')) || [];
        if(sales.length === 0) return alert("Aucune donnée à exporter frérot !");

        // En-têtes du fichier CSV
        let csvContent = "data:text/csv;charset=utf-8,Date,Heure,Montant,Methode,Statut\n";

        // Ajout des lignes
        sales.forEach(s => {
            const dateObj = new Date(s.id);
            const date = dateObj.toLocaleDateString('fr-FR');
            const heure = dateObj.toLocaleTimeString('fr-FR');
            csvContent += `${date},${heure},${s.total},${s.method},Termine\n`;
        });

        // Téléchargement du fichier
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `Rapport_Ventes_${localStorage.getItem('el_name') || 'Boutique'}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    loadData();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGIY POS ELITE ‚Äî Royal Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --gold: #fbbf24; --gold-dark: #d97706;
            --bg: #0f172a; --card: #1e293b;
            --text: #f8fafc; --muted: #94a3b8;
            --glass: rgba(255, 255, 255, 0.03);
            --gradient: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; background-image: radial-gradient(circle at top right, #1e293b, #0f172a); }
        
        #lockScreen { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(20px); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .lock-box { background: var(--card); padding: 40px; border-radius: 30px; border: 1px solid var(--gold); text-align: center; width: 90%; max-width: 400px; }

        .header { padding: 20px 25px; background: var(--glass); border-bottom: 1px solid rgba(251, 191, 36, 0.2); display: flex; justify-content: space-between; align-items: center; }
        .nav-elite { display: flex; gap: 10px; padding: 15px 25px; overflow-x: auto; scrollbar-width: none; }
        .nav-link { padding: 12px 25px; background: var(--card); border-radius: 12px; color: var(--muted); cursor: pointer; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; font-weight: 600; white-space: nowrap; }
        .nav-link.active { background: var(--gradient); color: #000; border-color: var(--gold); }

        .main-container { padding: 20px; display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
        @media (max-width: 1100px) { .main-container { grid-template-columns: 1fr; } }

        /* DASHBOARD CARDS */
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); text-align: center; }
        .stat-card h2 { color: var(--gold); font-size: 1.8rem; margin: 5px 0; }
        .stat-card small { color: var(--muted); text-transform: uppercase; font-size: 10px; letter-spacing: 1px; }

        .products-listing { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .noble-card { background: var(--card); padding: 20px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; cursor: pointer; }
        .noble-card:hover { border-color: var(--gold); transform: translateY(-3px); }

        .royal-cart { background: var(--card); border-radius: 25px; padding: 25px; border: 1px solid rgba(251, 191, 36, 0.1); height: fit-content; position: sticky; top: 20px; }
        .cart-scroll { max-height: 250px; overflow-y: auto; margin: 15px 0; }
        .cart-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; }

        .pay-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .pay-btn { padding: 12px; border: none; border-radius: 12px; color: white; font-weight: 800; cursor: pointer; font-size: 10px; }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .form-card { background: var(--card); padding: 25px; border-radius: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        input { width: 100%; padding: 14px; background: #0f172a; border: 1px solid #334155; border-radius: 10px; color: white; margin-top: 8px; outline: none; }
        .gold-btn { width: 100%; padding: 16px; background: var(--gradient); border: none; border-radius: 12px; color: #000; font-weight: 800; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

<div id="lockScreen">
    <div class="lock-box">
        <i class="fas fa-crown" style="font-size: 40px; color: var(--gold);"></i>
        <h2 style="margin: 15px 0;">ESSAI TERMIN√â</h2>
        <input type="text" id="royalKey" placeholder="CLE-PRO-2026">
        <button class="gold-btn" onclick="activate('royalKey')">ACTIVER</button>
    </div>
</div>

<div class="header">
    <div class="brand">
        <div class="crown-icon"><i class="fas fa-chart-line"></i></div>
        <div>
            <h2 id="storeDisp">BOUTIQUE</h2>
            <div id="syncStatus" style="font-size: 10px; color: #10b981;"><i class="fas fa-circle"></i> Cloud Sync Online</div>
        </div>
    </div>
    <div id="trialBadge"></div>
</div>

<div class="nav-elite">
    <div class="nav-link active" onclick="tab('pos', this)"><i class="fas fa-shopping-cart"></i> CAISSE</div>
    <div class="nav-link" onclick="tab('history', this)"><i class="fas fa-chart-bar"></i> DASHBOARD</div>
    <div class="nav-link" onclick="tab('admin', this)"><i class="fas fa-tools"></i> GESTION</div>
</div>

<div id="posPage" class="page active">
    <div class="main-container">
        <div id="productsGrid" class="products-listing"></div>
        <div class="royal-cart">
            <h3 style="font-size: 12px; color: var(--muted);">PANIER ACTUEL</h3>
            <div id="cartListing" class="cart-scroll"></div>
            <div style="display: flex; justify-content: space-between; border-top: 2px solid var(--gold); padding-top: 15px;">
                <b>TOTAL</b>
                <h2 id="totalPrice" style="color: var(--gold);">0 F</h2>
            </div>
            <div class="pay-grid">
                <button class="pay-btn" style="background: #10b981;" onclick="checkout('CASH')">CASH</button>
                <button class="pay-btn" style="background: #0ea5e9;" onclick="checkout('WAVE')">WAVE</button>
                <button class="pay-btn" style="background: #f97316;" onclick="checkout('OM')">ORANGE</button>
                <button class="pay-btn" style="background: #ef4444;" onclick="checkout('CREDIT')">DETTE</button>
                <button class="pay-btn" style="background: #64748b; grid-column: span 2;" onclick="db.cart=[];render()">VIDER LE PANIER</button>
            </div>
        </div>
    </div>
</div>

<div id="historyPage" class="page">
    <div class="main-container" style="display: block; max-width: 900px; margin: auto;">
        <div class="dash-grid">
            <div class="stat-card">
                <small>Recette du Jour</small>
                <h2 id="revDay">0 F</h2>
            </div>
            <div class="stat-card">
                <small>Ventes (Total)</small>
                <h2 id="totalSalesCount">0</h2>
            </div>
            <div class="stat-card">
                <small>CA Global</small>
                <h2 id="revTotal">0 F</h2>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-card">
                <h3>üèÜ TOP PRODUITS</h3>
                <div id="topProducts" style="margin-top: 15px;"></div>
            </div>
            <div class="form-card">
                <h3>‚ö†Ô∏è DETTES √Ä R√âCUP√âRER</h3>
                <div id="debtListing" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>
</div>

<div id="adminPage" class="page">
    <div class="main-container" style="display: block; max-width: 600px; margin: auto;">
        <div class="form-card" style="border: 1px solid var(--gold);">
            <h3>üë§ INFOS CLIENT & CLOUD</h3>
            <input type="text" id="custPhone" placeholder="Num√©ro WhatsApp (Identifiant Cloud)">
            <button class="gold-btn" onclick="fullSync()">FORCER LA SAUVEGARDE</button>
            <button class="gold-btn" style="background: #334155; color: white;" onclick="restoreSync()">RESTAURER DEPUIS LE CLOUD</button>
        </div>
        <div class="form-card">
            <h3>üì¶ AJOUTER ARTICLE</h3>
            <input type="text" id="addName" placeholder="Nom du produit">
            <input type="number" id="addPrice" placeholder="Prix de vente">
            <input type="number" id="addStock" placeholder="Stock initial">
            <button class="gold-btn" onclick="addNew()">VALIDER L'AJOUT</button>
        </div>
    </div>
</div>

<script>
const TRIAL_LIMIT = 15;
const SUPA_URL = 'https://wesqmwjjtsefyjnluosj.supabase.co/rest/v1/pos_daily_summaries';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA';

let db = {
    pro: localStorage.getItem('el_pro') === 'true',
    start: localStorage.getItem('el_start') || Date.now(),
    name: localStorage.getItem('el_name') || "MA BOUTIQUE",
    phone: localStorage.getItem('el_phone') || "",
    items: JSON.parse(localStorage.getItem('el_items')) || [],
    sales: JSON.parse(localStorage.getItem('el_sales')) || [],
    cart: []
};

if(!localStorage.getItem('el_start')) localStorage.setItem('el_start', db.start);

function tab(id, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    document.getElementById(id+'Page').classList.add('active');
    btn.classList.add('active');
    render();
}

function render() {
    // Verrouillage
    const diff = Date.now() - parseInt(db.start);
    const left = Math.max(0, TRIAL_LIMIT - Math.floor(diff / (1000 * 60 * 60 * 24)));
    if(!db.pro && left <= 0) document.getElementById('lockScreen').style.display = 'flex';
    
    document.getElementById('storeDisp').innerText = db.name;
    document.getElementById('trialBadge').innerHTML = db.pro ? '<b style="color:var(--gold)">PREMIUM</b>' : `<span style="background:var(--gold); color:black; padding:3px 8px; border-radius:8px; font-size:10px;">ESSAI: ${left}J</span>`;

    // Grille Caisse
    document.getElementById('productsGrid').innerHTML = db.items.map(p => `
        <div class="noble-card" onclick="addToCart(${p.id})">
            <i class="fas fa-tag" style="color:var(--gold); margin-bottom:10px;"></i><br>
            <b>${p.name}</b><br>
            <span style="color:var(--gold); font-weight:800;">${p.price.toLocaleString()} F</span><br>
            <small style="color:var(--muted)">Stock: ${p.stock}</small>
        </div>
    `).join('');

    // Panier
    document.getElementById('cartListing').innerHTML = db.cart.map(i => `
        <div class="cart-row"><span>${i.name} x${i.qty}</span><b>${(i.price*i.qty).toLocaleString()} F</b></div>
    `).join('');
    const total = db.cart.reduce((s,i) => s + (i.price*i.qty), 0);
    document.getElementById('totalPrice').innerText = total.toLocaleString() + " F";

    // --- LOGIQUE DASHBOARD ---
    const today = new Date().toLocaleDateString();
    const todaySales = db.sales.filter(s => new Date(s.id).toLocaleDateString() === today);
    
    document.getElementById('revDay').innerText = todaySales.reduce((s,x) => s+x.total, 0).toLocaleString() + " F";
    document.getElementById('totalSalesCount').innerText = db.sales.length;
    document.getElementById('revTotal').innerText = db.sales.reduce((s,x) => s+x.total, 0).toLocaleString() + " F";

    // Top Produits (Simplifi√©)
    const counts = {};
    db.sales.forEach(s => { if(s.items) s.items.forEach(i => counts[i.name] = (counts[i.name] || 0) + i.qty)});
    const top = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 3);
    document.getElementById('topProducts').innerHTML = top.length ? top.map(t => `<div class="cart-row"><span>${t[0]}</span><b>${t[1]} vendus</b></div>`).join('') : "Aucune vente";

    // Dettes
    const debts = db.sales.filter(s => s.method === 'CREDIT');
    document.getElementById('debtListing').innerHTML = debts.length ? debts.map(d => `<div class="cart-row"><span>Vente #${d.id.toString().slice(-4)}</span><b style="color:#ef4444;">${d.total} F</b></div>`).join('') : "Aucune dette";
}

function addToCart(id) {
    const p = db.items.find(x => x.id === id);
    if(p.stock <= 0) return alert("Rupture de stock !");
    const inCart = db.cart.find(x => x.id === id);
    if(inCart) inCart.qty++; else db.cart.push({...p, qty: 1});
    render();
}

function checkout(m) {
    if(!db.cart.length) return;
    const total = db.cart.reduce((s,i) => s + (i.price*i.qty), 0);
    const sale = { id: Date.now(), total: total, method: m, items: [...db.cart] };
    
    db.cart.forEach(i => db.items.find(p => p.id === i.id).stock -= i.qty);
    db.sales.push(sale);
    
    // Message WhatsApp
    let ticket = `*${db.name}*%0A--------------------------%0A`;
    db.cart.forEach(i => ticket += `${i.name} x${i.qty} : ${i.price*i.qty} F%0A`);
    ticket += `--------------------------%0A*TOTAL : ${total} F*%0A_Merci de votre confiance !_`;

    db.cart = [];
    save();
    fullSync(); // Sync auto vers le cloud

    if(confirm("Vente r√©ussie ! Envoyer le re√ßu ?")) {
        let p = prompt("Num√©ro WhatsApp du client (221...)");
        if(p) window.open(`https://wa.me/${p}?text=${ticket}`, '_blank');
    }
}

function addNew() {
    const n = document.getElementById('addName').value;
    const p = parseInt(document.getElementById('addPrice').value);
    const s = parseInt(document.getElementById('addStock').value);
    if(n && p) {
        db.items.push({id: Date.now(), name: n, price: p, stock: s});
        save();
        alert("Produit ajout√© !");
    }
}

function save() {
    localStorage.setItem('el_items', JSON.stringify(db.items));
    localStorage.setItem('el_sales', JSON.stringify(db.sales));
    render();
}

// --- CLOUD SYNC ---
async function fullSync() {
    const phone = document.getElementById('custPhone').value;
    if(!phone) return alert("Num√©ro WhatsApp requis pour le Cloud !");
    localStorage.setItem('el_phone', phone);
    
    const payload = {
        store_name: db.name,
        owner_phone: phone,
        total_ca: db.sales.reduce((a,b) => a + b.total, 0),
        backup_data: JSON.stringify({ items: db.items, sales: db.sales }),
        date: new Date().toISOString()
    };

    try {
        await fetch(SUPA_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY },
            body: JSON.stringify(payload)
        });
        alert("Donn√©es synchronis√©es sur le Cloud DIGIY !");
    } catch(e) { console.error("Sync Error"); }
}

async function restoreSync() {
    const phone = document.getElementById('custPhone').value;
    if(!phone) return alert("Num√©ro requis !");
    try {
        const res = await fetch(`${SUPA_URL}?owner_phone=eq.${phone}&order=date.desc&limit=1`, {
            headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY }
        });
        const data = await res.json();
        if(data[0]) {
            const backup = JSON.parse(data[0].backup_data);
            db.items = backup.items;
            db.sales = backup.sales;
            save();
            alert("Restauration r√©ussie fr√©rot !");
        }
    } catch(e) { alert("Erreur de r√©cup√©ration."); }
}

function activate(id) {
    if(document.getElementById(id).value === "DIGIY-PRO-2026") {
        localStorage.setItem('el_pro', 'true');
        location.reload();
    }
}

document.getElementById('custPhone').value = db.phone;
render();
</script>
</body>
</html>

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#020617"/>
  <title>DIGIY ADMIN ‚Äî Cr√©er un commer√ßant</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#020617;
      --card:#0B1120;
      --line:rgba(148,163,184,.22);
      --ink:#F9FAFB;
      --muted:#94A3B8;
      --gold:#facc15;
      --green:#22c55e;
      --red:#ef4444;
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      background:radial-gradient(circle at 20% 10%,rgba(250,204,21,.10),transparent 55%),
                 radial-gradient(circle at 80% 90%,rgba(34,211,238,.10),transparent 60%),
                 var(--bg);
      color:var(--ink);
      padding:18px;
    }
    .wrap{max-width:980px;margin:0 auto}
    .top{
      border:1px solid var(--line);
      background:rgba(2,6,23,.78);
      border-radius:22px;
      padding:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:var(--shadow);
    }
    h1{
      font-size:15px;
      font-weight:950;
      letter-spacing:.10em;
      text-transform:uppercase;
    }
    .sub{font-size:12px;color:var(--muted);margin-top:6px}
    .pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 12px;
      background:rgba(250,204,21,.10);
      font-weight:900;
      font-size:12px;
    }

    .card{
      margin-top:14px;
      border:1px solid var(--line);
      background:rgba(11,17,32,.92);
      border-radius:22px;
      padding:16px;
      box-shadow:var(--shadow);
    }
    label{
      display:block;
      margin:10px 0 6px;
      font-weight:900;
      font-size:12px;
      color:#fff;
    }
    input,select{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--ink);
      font-weight:850;
      outline:none;
    }
    input:focus,select:focus{
      border-color:rgba(250,204,21,.8);
      box-shadow:0 0 0 3px rgba(250,204,21,.12);
    }
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media(max-width:800px){
      .grid{grid-template-columns:1fr}
    }

    .btn{
      margin-top:14px;
      width:100%;
      padding:14px;
      border:none;
      border-radius:14px;
      font-weight:950;
      cursor:pointer;
      background:linear-gradient(135deg,var(--gold),#f97316);
      color:#111827;
      font-size:14px;
    }
    .btn:hover{filter:brightness(1.03)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .out{
      margin-top:14px;
      border:1px solid rgba(34,197,94,.30);
      background:rgba(34,197,94,.10);
      padding:14px;
      border-radius:16px;
      display:none;
    }
    .out.bad{
      border-color:rgba(239,68,68,.35);
      background:rgba(239,68,68,.08);
    }
    .code{
      margin-top:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      font-family:ui-monospace,Menlo,monospace;
      font-size:12px;
      white-space:pre-wrap;
      word-break:break-all;
    }
    .miniRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .miniBtn{
      flex:1;
      min-width:220px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .miniBtn:hover{border-color:rgba(250,204,21,.6)}
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div>
      <h1>ADMIN ‚Äî Cr√©er un commer√ßant</h1>
      <div class="sub">Slug + PIN + QR imm√©diat ‚Ä¢ Activation module</div>
    </div>
    <div class="pill">DIGIY CONTROL ü¶Ö</div>
  </div>

  <div class="card">
    <div class="grid">

      <div>
        <label>Nom commerce</label>
        <input id="name" placeholder="Chez Astou Saly"/>
      </div>

      <div>
        <label>T√©l√©phone</label>
        <input id="phone" placeholder="+22177xxxxxxx"/>
      </div>

      <div>
        <label>Module initial</label>
        <select id="module">
          <option value="loc_pro">LOC PRO</option>
          <option value="driver_pro">DRIVER PRO</option>
          <option value="caisse_pro">CAISSE PRO</option>
          <option value="resto_pro">RESTO PRO</option>
          <option value="market_pro">MARKET PRO</option>
          <option value="qr_pro">QR PRO</option>
        </select>
      </div>

      <div>
        <label>PIN (auto si vide)</label>
        <input id="pin" placeholder="1234"/>
      </div>

    </div>

    <button id="btn" class="btn">‚ö° CR√âER LE COMMER√áANT</button>

    <div id="out" class="out">
      <b id="titleOut">‚úÖ Cr√©√©</b>
      <div class="code" id="codeBox"></div>

      <div class="miniRow">
        <button class="miniBtn" id="copyBtn">üìã Copier tout</button>
        <button class="miniBtn" id="openPin">üîê Ouvrir PIN</button>
        <button class="miniBtn" id="openQR">üì∑ QR FACTORY</button>
      </div>
    </div>
  </div>

</div>

<script>
(async()=>{
  // ‚úÖ SUPABASE CONFIG
  const SUPABASE_URL="https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY="YOUR_ANON_KEY_HERE";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $=(id)=>document.getElementById(id);
  const out=$("out");
  const codeBox=$("codeBox");
  const btn=$("btn");

  function slugify(str){
    return (str||"")
      .trim().toLowerCase()
      .replace(/[^a-z0-9\s-]/g,"")
      .replace(/\s+/g,"-")
      .replace(/-+/g,"-");
  }

  function genPin(){
    return String(Math.floor(1000 + Math.random()*9000));
  }

  async function copy(txt){
    await navigator.clipboard.writeText(txt);
    alert("‚úÖ Copi√© fr√©rot");
  }

  btn.onclick = async ()=>{
    out.style.display="none";

    const name = $("name").value.trim();
    const phone = $("phone").value.trim();
    const module = $("module").value;
    let pin = $("pin").value.trim();

    if(!name || !phone){
      alert("Nom + t√©l√©phone requis fr√©rot");
      return;
    }

    if(!pin) pin = genPin();

    const slug = slugify(name);

    btn.disabled=true;
    btn.textContent="Cr√©ation‚Ä¶";

    try{
      // ‚úÖ RPC ADMIN (√† cr√©er c√¥t√© Supabase)
      const { data, error } = await sb.rpc("digiy_admin_create_merchant_v1",{
        p_name: name,
        p_phone: phone,
        p_slug: slug,
        p_pin: pin,
        p_module: module
      });

      if(error) throw error;
      if(!data?.ok) throw new Error(data?.reason||"Erreur cr√©ation");

      const pinUrl = `https://beauville.github.io/${module}/pin.html?slug=${slug}`;
      const qrUrl  = `https://beauville.github.io/digiy-qr-pro/?slug=${slug}`;

      const text =
`‚úÖ DIGIY MERCHANT CR√â√â

Nom   : ${name}
Tel   : ${phone}
Slug  : ${slug}
PIN   : ${pin}
Module: ${module}

üîê PIN URL:
${pinUrl}

üì∑ QR FACTORY:
${qrUrl}
`;

      codeBox.textContent=text;
      out.style.display="block";

      $("copyBtn").onclick=()=>copy(text);
      $("openPin").onclick=()=>window.open(pinUrl,"_blank");
      $("openQR").onclick=()=>window.open(qrUrl,"_blank");

    }catch(e){
      out.classList.add("bad");
      out.style.display="block";
      codeBox.textContent="‚ùå ERREUR:\n"+(e.message||e);
    }

    btn.disabled=false;
    btn.textContent="‚ö° CR√âER LE COMMER√áANT";
  };

})();
</script>

</body>
</html>
